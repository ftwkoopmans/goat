(function(){"use strict";onmessage=e=>{const n=JSON.parse(e.data);try{k(n.gl,n.gs,n.nulldistr,n.scoreType,n.selectedMinSize,n.selectedMaxSize,n.selectedPvalueAdjustment,n.selectedPvalueThreshold)}catch(r){postMessage(r)}};async function k(e,n,r,f,a,o,t,s){const i=e.length,_=D(e,f);let c;const l=r.length;for(let g=0;g<l;g++)if(r[g].N===i){c=r[g];break}if(c===void 0)throw new Error("null distribution parameters for your genelist of length "+i+" are not available");const u=V(n,e,+a,Math.min(+o,Math.ceil(i/2)),0);C(u,e,_,c),G(u,_);const m=S(u,t,+s);postMessage({scoretype_props:_,gs_filtered:u,stats:m,gl:e})}function D(e,n){function r(s,i){const _=s.length,c=_*_/1e3;let l=0;for(let u=0;u<_;u++)l=(_-u)*(_-u)/c,s[u][i]=l,l>s[u].sort_score&&(s[u].sort_score=l)}if(Array.isArray(e)===!1)throw new Error("genelist is expected to be an array (of objects, with properties like gene/symbol/pvalue/effectsize)");const f=e[0].hasOwnProperty("pvalue")&&typeof e[0].pvalue=="number",a=e[0].hasOwnProperty("effectsize")&&typeof e[0].effectsize=="number",o=e.length;for(let s=0;s<o;s++)e[s].sort_score=0,delete e[s].score_pvalue,delete e[s].score_effectsize_up,delete e[s].score_effectsize_down,delete e[s].score_effectsize_abs;let t=[];if(n==="effectsize"?(t=["effectsize_up","effectsize_down"],e.sort((s,i)=>i.gene-s.gene),f&&e.sort((s,i)=>s.pvalue-i.pvalue),e.sort((s,i)=>i.effectsize-s.effectsize),r(e,"score_effectsize_up"),e.sort((s,i)=>i.gene-s.gene),f&&e.sort((s,i)=>s.pvalue-i.pvalue),e.sort((s,i)=>s.effectsize-i.effectsize),r(e,"score_effectsize_down")):n==="effectsize_up"?(t=["effectsize_up"],e.sort((s,i)=>i.gene-s.gene),f&&e.sort((s,i)=>s.pvalue-i.pvalue),e.sort((s,i)=>i.effectsize-s.effectsize),r(e,"score_effectsize_up")):n==="effectsize_down"?(t=["effectsize_down"],e.sort((s,i)=>i.gene-s.gene),f&&e.sort((s,i)=>s.pvalue-i.pvalue),e.sort((s,i)=>s.effectsize-i.effectsize),r(e,"score_effectsize_down")):n==="effectsize_abs"?(t=["effectsize_abs"],e.sort((s,i)=>i.gene-s.gene),f&&e.sort((s,i)=>s.pvalue-i.pvalue),e.sort((s,i)=>Math.abs(i.effectsize)-Math.abs(s.effectsize)),r(e,"score_effectsize_abs")):n==="pvalue"&&(t=["pvalue"],e.sort((s,i)=>i.gene-s.gene),a&&e.sort((s,i)=>Math.abs(i.effectsize)-Math.abs(s.effectsize)),e.sort((s,i)=>s.pvalue-i.pvalue),r(e,"score_pvalue")),t.length===0)throw new Error("unknown scoretype parameter; "+n);return t}function F(e,n){const r=2/Math.sqrt(2*Math.PI),f=r*(n-1/n),a=Math.sqrt((1-r*r)*(n*n+1/(n*n))+2*(r*r)-1),o=e*a+f,t=2/(n+1/n);let s=n;o<0&&(s=1/s);let i=1;return o>=0?i=t*s*E(o/s,0,1,!1,!1):i=1-t*s*E(o/s,0,1,!0,!1),i>1&&(i=1),i}function q(e,n,r,f){return f<1.0001?E((e-n)/r,0,1,!1,!1):F((e-n)/r,f)}function I(e){const n=e.length,r=Array.from({length:n},(s,i)=>n-i),f=Array.from(e.keys()).sort((s,i)=>e[i]-e[s]),a=Array.from(f.keys()).sort((s,i)=>f[s]-f[i]);let o=new Float64Array(n),t=1;for(let s=0;s<n;s++)o[s]=n/r[s]*e[f[s]],t=t<o[s]?t:o[s],o[s]=t;for(let s=0;s<n;s++)e[s]=o[a[s]]>1?1:o[a[s]];return e}function L(e,n){const r=e.reduce((t,s)=>t+(typeof s=="number"&&!isNaN(s)),0),f=e.length;let a=0,o=new Float64Array(f);for(let t=0;t<f;t++)o[t]=NaN;if(r===0)return o;if(n==="bonferroni"){for(let t=0;t<f;t++)typeof e[t]=="number"&&!isNaN(e[t])&&(a=e[t]*r,o[t]=a>1?1:a);return o}if(n==="fdr"||n==="BH"){if(f===r)o=I(e);else{const t=e.filter(_=>typeof _=="number"&&!isNaN(_)),s=I(t);let i=0;for(let _=0;_<f;_++)typeof e[_]=="number"&&!isNaN(e[_])&&(o[_]=s[i],i+=1)}return o}console.error("unknown padjust method; "+n)}function C(e,n,r,f){const a=n.length,o={};for(let h=0;h<a;h++)o[n[h].gene]=n[h];const t=r.map(h=>"score_"+h),s=r.length,i=e.length;let _,c,l,u,m,g,d,M=new Array(s);for(let h=0;h<i;h++){let w=e[h].genesets.length;for(let p=0;p<w;p++){u=e[h].genesets[p].genes,m=u.length,e[h].genesets[p].score=NaN,e[h].genesets[p].zscore=NaN,e[h].genesets[p].score_type="",e[h].genesets[p].pvalue=NaN,e[h].genesets[p].pvalue_adjust=NaN,e[h].genesets[p].signif=void 0,M.fill(0),c=0,l="";for(let N=0;N<m;N++){if(d=o[u[N]],d===void 0)throw new Error("cannot find this geneset gene in genelist; "+u[N]);for(let z=0;z<s;z++)M[z]+=d[t[z]]}for(let N=0;N<s;N++)M[N]>c&&(c=M[N],l=r[N]);e[h].genesets[p].score=c/m,e[h].genesets[p].score_type=l,_=Q(m,f),g=q(e[h].genesets[p].score,f.mu,_.sd,_.xi),g=Math.min(1,g*s),e[h].genesets[p].pvalue=g}}}function G(e,n){const r=n.indexOf("effectsize_down")!==-1;let f=1,a=0;const o=e.length;for(let t=0;t<o;t++){let s=e[t].genesets.length;if(s>0){if(e[t].genesets[0].hasOwnProperty("pvalue")===!1)throw new Error("genesets do not have a pvalue property, cannot compute z-scores");for(let i=0;i<s;i++)a=re(e[t].genesets[i].pvalue/2,0,1,!1,!1),r&&(f=e[t].genesets[i].score_type==="effectsize_up"?1:-1,a=a*f),e[t].genesets[i].zscore=a}}}function S(e,n,r){const f=e.length;let a=0;const o={signif_count:0,signif_max_ngenes:0,signif_max_ngenes_input:0,signif_max_ngenes_signif:0,signif_min_pvalue_adjust:1};for(let t=0;t<f;t++){e[t].stats={signif_count:0,signif_max_ngenes:0,signif_max_ngenes_input:0,signif_max_ngenes_signif:0,signif_min_pvalue_adjust:1};let s=e[t].genesets.length;if(s>0){if(e[t].genesets[0].hasOwnProperty("pvalue")===!1)throw new Error("genesets do not have a pvalue property, cannot compute adjusted p-values");let i=new Float64Array(s);for(let _=0;_<s;_++)i[_]=e[t].genesets[_].pvalue;i=L(i,n);for(let _=0;_<s;_++)a=i[_]*f,a=a>1?1:a,e[t].genesets[_].pvalue_adjust=a,e[t].genesets[_].signif=isNaN(a)?void 0:a<=r,e[t].genesets[_].signif===!0&&(e[t].stats.signif_count++,e[t].genesets[_].ngenes>e[t].stats.signif_max_ngenes&&(e[t].stats.signif_max_ngenes=e[t].genesets[_].ngenes),e[t].genesets[_].ngenes_input>e[t].stats.signif_max_ngenes_input&&(e[t].stats.signif_max_ngenes_input=e[t].genesets[_].ngenes_input),e[t].genesets[_].ngenes_signif>e[t].stats.signif_max_ngenes_signif&&(e[t].stats.signif_max_ngenes_signif=e[t].genesets[_].ngenes_signif),e[t].genesets[_].pvalue_adjust<e[t].stats.signif_min_pvalue_adjust&&(e[t].stats.signif_min_pvalue_adjust=e[t].genesets[_].pvalue_adjust));o.signif_count+=e[t].stats.signif_count,e[t].stats.signif_max_ngenes>o.signif_max_ngenes&&(o.signif_max_ngenes=e[t].stats.signif_max_ngenes),e[t].stats.signif_max_ngenes_input>o.signif_max_ngenes_input&&(o.signif_max_ngenes_input=e[t].stats.signif_max_ngenes_input),e[t].stats.signif_max_ngenes_signif>o.signif_max_ngenes_signif&&(o.signif_max_ngenes_signif=e[t].stats.signif_max_ngenes_signif),e[t].stats.signif_min_pvalue_adjust<o.signif_min_pvalue_adjust&&(o.signif_min_pvalue_adjust=e[t].stats.signif_min_pvalue_adjust)}}return o}function V(e,n,r,f,a){if(Number.isInteger(r)===!1||r<10)throw new Error("minSize must be an integer number larger than 10");if(Number.isInteger(f)===!1||f<=r||f>Math.ceil(n.length/2))throw new Error("maxSize must be an integer number larger than minSize and smaller than half the genelist length");if((a===void 0||a===0)&&(a=9999999999999),Number.isInteger(a)===!1||a<f)throw new Error("maxSizeInput must be an integer number larger-equals than maxSize");const o=new Set(n.map(g=>g.gene)),t=new Set(n.filter(g=>g.signif===!0).map(g=>g.gene)),s=[],i=e.length;let _,c,l,u,m;for(let g=0;g<i;g++)if(_=e[g].genesets.length,_>0){m=[];for(let d=0;d<_;d++){if(c=e[g].genesets[d].genes,!Array.isArray(c))throw console.error(e[g].genesets[d]),new Error("invalid genesets object; no genes available for geneset at index "+d+" at source index "+g);c.length<a&&(l=c.filter(M=>o.has(M)),l.length>=r&&l.length<=f&&(u=l.filter(M=>t.has(M)),m.push({id:e[g].genesets[d].id,name:e[g].genesets[d].name,parents:e[g].genesets[d].parents,ngenes_input:c.length,ngenes:l.length,ngenes_signif:u.length,genes:l,genes_signif:u})))}s.push({source:e[g].source,source_version:e[g].source_version,genesets:m})}return s}function $(e,n){return n.sigma_0+n.sigma_1*e+n.sigma_2*Math.pow(e,2)+n.sigma_3*Math.pow(e,3)+n.sigma_4*Math.pow(e,4)+n.sigma_5*Math.pow(e,5)+n.sigma_6*Math.pow(e,6)+n.sigma_7*Math.pow(e,7)+n.sigma_8*Math.pow(e,8)+n.sigma_9*Math.pow(e,9)}function x(e,n){return n.xi_0+n.xi_1*e+n.xi_2*Math.pow(e,2)+n.xi_3*Math.pow(e,3)+n.xi_4*Math.pow(e,4)+n.xi_5*Math.pow(e,5)+n.xi_6*Math.pow(e,6)+n.xi_7*Math.pow(e,7)+n.xi_8*Math.pow(e,8)+n.xi_9*Math.pow(e,9)+n.xi_10*Math.pow(e,10)+n.xi_11*Math.pow(e,11)}function Q(e,n){const r=Math.log(e),f=$(r,n);let a=Math.exp(x(r,n));return a=a<1?1:a,{sd:f,xi:a}}const Y=2220446049250313e-31,B=5.656854249492381,W=.3989422804014327,y=1,H=2,J=4,U=8,X=16,K=[2.2352520354606837,161.02823106855587,1067.6894854603709,18154.98125334356,.06568233791820745],Z=[47.202581904688245,976.0985517377767,10260.932208618979,45507.78933502673],b=[.39894151208813466,8.883149794388377,93.50665613217785,597.2702763948002,2494.5375852903726,6848.190450536283,11602.65143764735,9842.714838383978,10765576773720192e-24],j=[22.266688044328117,235.387901782625,1519.3775994075547,6485.558298266761,18615.571640885097,34900.95272114598,38912.00328609327,19685.429676859992],ee=[.215898534057957,.12740116116024736,.022235277870649807,.0014216191932278934,29112874951168793e-21,.023073441764940174],se=[1.284260096144911,.4682382124808651,.06598813786892856,.0037823963320275824,7297515550839662e-20],O=e=>e?-1/0:0,A=e=>e?0:1,P=(e,n)=>e?O(n):A(n),T=(e,n)=>e?A(n):O(n);function E(e,n,r,f,a){var o;if(isNaN(e)||isNaN(n)||isNaN(r))return NaN;if(!Number.isFinite(e)&&n===e)return NaN;if(r<=0)return r<0?NaN:e<n?P(f,a):T(f,a);if(o=(e-n)/r,!Number.isFinite(o))return e<n?P(f,a):T(f,a);e=o;var t=ne(e,f?0:1,a);return f?t.cum:t.ccum}function v(e,n){return e===0?n?Number.NEGATIVE_INFINITY:0:n?0:1}function ne(e,n,r){var f,a,o,t,s,i,_,c,l,u,m,g,d=K,M=Z,h=b,w=j,p=ee,N=se;if(isNaN(e))return{cum:NaN,ccum:NaN};if(_=Y*.5,m=n!==1,g=n!==0,l=Math.abs(e),l<=.67448975){if(l>_)for(c=e*e,t=d[4]*c,o=c,u=0;u<3;++u)t=(t+d[u])*c,o=(o+M[u])*c;else t=o=0;s=e*(t+d[3])/(o+M[3]),m&&(f=.5+s),g&&(a=.5-s),r&&(m&&(f=Math.log(f)),g&&(a=Math.log(a)))}else if(l<=B){for(t=h[8]*l,o=l,u=0;u<7;++u)t=(t+h[u])*l,o=(o+w[u])*l;s=(t+h[7])/(o+w[7]),c=Math.trunc(l*16)/16,i=(l-c)*(l+c),r?(f=-c*c*.5+-i*.5+Math.log(s),(m&&e>0||g&&e<=0)&&(a=Math.log1p(-Math.exp(-c*c*.5)*Math.exp(-i*.5)*s))):(f=Math.exp(-c*c*.5)*Math.exp(-i*.5)*s,a=1-f),e>0&&(s=f,m&&(f=a),a=s)}else if(r&&l<1e170||m&&-37.5193<e&&e<8.2924||g&&e<37.5193){for(c=1/(e*e),t=p[5]*c,o=c,u=0;u<4;++u)t=(t+p[u])*c,o=(o+N[u])*c;s=c*(t+p[4])/(o+N[4]),s=(W-s)/l,c=Math.trunc(e*16)/16,i=(e-c)*(e+c),r?(f=-c*c*.5+-i*.5+Math.log(s),(m&&e>0||g&&e<=0)&&(a=Math.log1p(-Math.exp(-c*c*.5)*Math.exp(-i*.5)*s))):(f=Math.exp(-c*c*.5)*Math.exp(-i*.5)*s,a=1-f),e>0&&(s=f,m&&(f=a),a=s)}else e>0?(f=v(1,r),a=v(0,r)):(f=v(0,r),a=v(1,r));return{cum:f,ccum:a}}const te=(e,n)=>n?e:.5-e+.5,ie=(e,n)=>n?.5-e+.5:e;function re(e,n,r,f,a){let o,t,s,i;if(isNaN(e)||isNaN(n)||isNaN(r))return e+n+r;try{fe(e,f,a,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY)}catch(_){return _}return r<0?R():r===0?n:(o=ae(e,f,a),t=o-.5,Math.abs(t)<=.425?(s=.180625-t*t,i=t*(((((((s*2509.0809287301227+33430.57558358813)*s+67265.7709270087)*s+45921.95393154987)*s+13731.69376550946)*s+1971.5909503065513)*s+133.14166789178438)*s+3.3871328727963665)/(((((((s*5226.495278852854+28729.085735721943)*s+39307.89580009271)*s+21213.794301586597)*s+5394.196021424751)*s+687.1870074920579)*s+42.31333070160091)*s+1)):(t>0?s=oe(e,f,a):s=o,s=Math.sqrt(-(a&&(f&&t<=0||!f&&t>0)?e:Math.log(s))),s<=5?(s+=-1.6,i=(((((((s*.0007745450142783414+.022723844989269184)*s+.2417807251774506)*s+1.2704582524523684)*s+3.6478483247632045)*s+5.769497221460691)*s+4.630337846156546)*s+1.4234371107496835)/(((((((s*10507500716444169e-25+.0005475938084995345)*s+.015198666563616457)*s+.14810397642748008)*s+.6897673349851)*s+1.6763848301838038)*s+2.053191626637759)*s+1)):(s+=-5,i=(((((((s*20103343992922881e-23+27115555687434876e-21)*s+.0012426609473880784)*s+.026532189526576124)*s+.29656057182850487)*s+1.7848265399172913)*s+5.463784911164114)*s+6.657904643501103)/(((((((s*20442631033899397e-31+1421511758316446e-22)*s+18463183175100548e-21)*s+.0007868691311456133)*s+.014875361290850615)*s+.1369298809227358)*s+.599832206555888)*s+1)),t<0&&(i=-i)),n+r*i)}function fe(e,n,r,f,a){if(r){if(e>0)throw R();if(e===0)throw n?a:f;if(e===Number.NEGATIVE_INFINITY)throw n?f:a}else{if(e<0||e>1)throw R();if(e===0)throw n?f:a;if(e===1)throw n?a:f}}function ae(e,n,r){return r?n?Math.exp(e):-Math.expm1(e):te(e,n)}function oe(e,n,r){return r?n?-Math.expm1(e):Math.exp(e):ie(e)}function R(){return _e(y,""),NaN}function _e(e,n){if(e>y){let r="";switch(e){case y:r=`argument out of domain in ${n}`;break;case H:r=`value out of range in ${n}`;break;case J:r=`convergence failed in ${n}`;break;case U:r=`full precision may not have been achieved in ${n}`;break;case X:r=`underflow occurred in ${n}`;break}console.error(r)}}})();
