(function(){"use strict";onmessage=e=>{const s=JSON.parse(e.data);try{k(s.gl,s.gs,s.nulldistr,s.scoreType,s.selectedMinSize,s.selectedMaxSize,s.selectedPvalueAdjustment,s.selectedPvalueThreshold)}catch(f){postMessage(f)}};async function k(e,s,f,r,a,o,t,n){const i=e.length,_=D(e,r);let c;const l=f.length;for(let g=0;g<l;g++)if(f[g].N===i){c=f[g];break}if(c===void 0)throw new Error("null distribution parameters for your genelist of length "+i+" are not available");const u=V(s,e,+a,Math.min(+o,Math.ceil(i/2)),0);C(u,e,_,c),G(u,_);const m=S(u,t,+n);postMessage({scoretype_props:_,gs_filtered:u,stats:m,gl:e})}function D(e,s){function f(n,i){const _=n.length,c=_*_/1e3;let l=0;for(let u=0;u<_;u++)l=(_-u)*(_-u)/c,n[u][i]=l,l>n[u].sort_score&&(n[u].sort_score=l)}if(Array.isArray(e)===!1)throw new Error("genelist is expected to be an array (of objects, with properties like gene/symbol/pvalue/effectsize)");const r=e[0].hasOwnProperty("pvalue")&&typeof e[0].pvalue=="number",a=e[0].hasOwnProperty("effectsize")&&typeof e[0].effectsize=="number",o=e.length;for(let n=0;n<o;n++)e[n].sort_score=0,delete e[n].score_pvalue,delete e[n].score_effectsize_up,delete e[n].score_effectsize_down,delete e[n].score_effectsize_abs;let t=[];if(s==="effectsize"?(t=["effectsize_up","effectsize_down"],e.sort((n,i)=>i.gene-n.gene),r&&e.sort((n,i)=>n.pvalue-i.pvalue),e.sort((n,i)=>i.effectsize-n.effectsize),f(e,"score_effectsize_up"),e.sort((n,i)=>i.gene-n.gene),r&&e.sort((n,i)=>n.pvalue-i.pvalue),e.sort((n,i)=>n.effectsize-i.effectsize),f(e,"score_effectsize_down")):s==="effectsize_up"?(t=["effectsize_up"],e.sort((n,i)=>i.gene-n.gene),r&&e.sort((n,i)=>n.pvalue-i.pvalue),e.sort((n,i)=>i.effectsize-n.effectsize)):s==="effectsize_down"?(t=["effectsize_down"],e.sort((n,i)=>i.gene-n.gene),r&&e.sort((n,i)=>n.pvalue-i.pvalue),e.sort((n,i)=>n.effectsize-i.effectsize)):s==="effectsize_abs"?(t=["effectsize_abs"],e.sort((n,i)=>i.gene-n.gene),r&&e.sort((n,i)=>n.pvalue-i.pvalue),e.sort((n,i)=>Math.abs(i.effectsize)-Math.abs(n.effectsize)),f(e,"score_effectsize_abs")):s==="pvalue"&&(t=["pvalue"],e.sort((n,i)=>i.gene-n.gene),a&&e.sort((n,i)=>Math.abs(i.effectsize)-Math.abs(n.effectsize)),e.sort((n,i)=>n.pvalue-i.pvalue),f(e,"score_pvalue")),t.length===0)throw new Error("unknown scoretype parameter; "+s);return t}function F(e,s){const f=2/Math.sqrt(2*Math.PI),r=f*(s-1/s),a=Math.sqrt((1-f*f)*(s*s+1/(s*s))+2*(f*f)-1),o=e*a+r,t=2/(s+1/s);let n=s;o<0&&(n=1/n);let i=1;return o>=0?i=t*n*E(o/n,0,1,!1,!1):i=1-t*n*E(o/n,0,1,!0,!1),i>1&&(i=1),i}function q(e,s,f,r){return r<1.0001?E((e-s)/f,0,1,!1,!1):F((e-s)/f,r)}function I(e){const s=e.length,f=Array.from({length:s},(n,i)=>s-i),r=Array.from(e.keys()).sort((n,i)=>e[i]-e[n]),a=Array.from(r.keys()).sort((n,i)=>r[n]-r[i]);let o=new Float64Array(s),t=1;for(let n=0;n<s;n++)o[n]=s/f[n]*e[r[n]],t=t<o[n]?t:o[n],o[n]=t;for(let n=0;n<s;n++)e[n]=o[a[n]]>1?1:o[a[n]];return e}function L(e,s){const f=e.reduce((t,n)=>t+(typeof n=="number"&&!isNaN(n)),0),r=e.length;let a=0,o=new Float64Array(r);for(let t=0;t<r;t++)o[t]=NaN;if(f===0)return o;if(s==="bonferroni"){for(let t=0;t<r;t++)typeof e[t]=="number"&&!isNaN(e[t])&&(a=e[t]*f,o[t]=a>1?1:a);return o}if(s==="fdr"||s==="BH"){if(r===f)o=I(e);else{const t=e.filter(_=>typeof _=="number"&&!isNaN(_)),n=I(t);let i=0;for(let _=0;_<r;_++)typeof e[_]=="number"&&!isNaN(e[_])&&(o[_]=n[i],i+=1)}return o}console.error("unknown padjust method; "+s)}function C(e,s,f,r){const a=s.length,o={};for(let h=0;h<a;h++)o[s[h].gene]=s[h];const t=f.map(h=>"score_"+h),n=f.length,i=e.length;let _,c,l,u,m,g,N,M=new Array(n);for(let h=0;h<i;h++){let w=e[h].genesets.length;for(let p=0;p<w;p++){u=e[h].genesets[p].genes,m=u.length,e[h].genesets[p].score=NaN,e[h].genesets[p].zscore=NaN,e[h].genesets[p].score_type="",e[h].genesets[p].pvalue=NaN,e[h].genesets[p].pvalue_adjust=NaN,e[h].genesets[p].signif=void 0,M.fill(0),c=0,l="";for(let d=0;d<m;d++){if(N=o[u[d]],N===void 0)throw new Error("cannot find this geneset gene in genelist; "+u[d]);for(let z=0;z<n;z++)M[z]+=N[t[z]]}for(let d=0;d<n;d++)M[d]>c&&(c=M[d],l=f[d]);e[h].genesets[p].score=c/m,e[h].genesets[p].score_type=l,_=Q(m,r),g=q(e[h].genesets[p].score,r.mu,_.sd,_.xi),g=Math.min(1,g*n),e[h].genesets[p].pvalue=g}}}function G(e,s){const f=s.indexOf("effectsize_down")!==-1;let r=1,a=0;const o=e.length;for(let t=0;t<o;t++){let n=e[t].genesets.length;if(n>0){if(e[t].genesets[0].hasOwnProperty("pvalue")===!1)throw new Error("genesets do not have a pvalue property, cannot compute z-scores");for(let i=0;i<n;i++)a=re(e[t].genesets[i].pvalue/2,0,1,!1,!1),f&&(r=e[t].genesets[i].score_type==="effectsize_up"?1:-1,a=a*r),e[t].genesets[i].zscore=a}}}function S(e,s,f){const r=e.length;let a=0;const o={signif_count:0,signif_max_ngenes:0,signif_max_ngenes_input:0,signif_max_ngenes_signif:0,signif_min_pvalue_adjust:1};for(let t=0;t<r;t++){e[t].stats={signif_count:0,signif_max_ngenes:0,signif_max_ngenes_input:0,signif_max_ngenes_signif:0,signif_min_pvalue_adjust:1};let n=e[t].genesets.length;if(n>0){if(e[t].genesets[0].hasOwnProperty("pvalue")===!1)throw new Error("genesets do not have a pvalue property, cannot compute adjusted p-values");let i=new Float64Array(n);for(let _=0;_<n;_++)i[_]=e[t].genesets[_].pvalue;i=L(i,s);for(let _=0;_<n;_++)a=i[_]*r,a=a>1?1:a,e[t].genesets[_].pvalue_adjust=a,e[t].genesets[_].signif=isNaN(a)?void 0:a<=f,e[t].genesets[_].signif===!0&&(e[t].stats.signif_count++,e[t].genesets[_].ngenes>e[t].stats.signif_max_ngenes&&(e[t].stats.signif_max_ngenes=e[t].genesets[_].ngenes),e[t].genesets[_].ngenes_input>e[t].stats.signif_max_ngenes_input&&(e[t].stats.signif_max_ngenes_input=e[t].genesets[_].ngenes_input),e[t].genesets[_].ngenes_signif>e[t].stats.signif_max_ngenes_signif&&(e[t].stats.signif_max_ngenes_signif=e[t].genesets[_].ngenes_signif),e[t].genesets[_].pvalue_adjust<e[t].stats.signif_min_pvalue_adjust&&(e[t].stats.signif_min_pvalue_adjust=e[t].genesets[_].pvalue_adjust));o.signif_count+=e[t].stats.signif_count,e[t].stats.signif_max_ngenes>o.signif_max_ngenes&&(o.signif_max_ngenes=e[t].stats.signif_max_ngenes),e[t].stats.signif_max_ngenes_input>o.signif_max_ngenes_input&&(o.signif_max_ngenes_input=e[t].stats.signif_max_ngenes_input),e[t].stats.signif_max_ngenes_signif>o.signif_max_ngenes_signif&&(o.signif_max_ngenes_signif=e[t].stats.signif_max_ngenes_signif),e[t].stats.signif_min_pvalue_adjust<o.signif_min_pvalue_adjust&&(o.signif_min_pvalue_adjust=e[t].stats.signif_min_pvalue_adjust)}}return o}function V(e,s,f,r,a){if(Number.isInteger(f)===!1||f<10)throw new Error("minSize must be an integer number larger than 10");if(Number.isInteger(r)===!1||r<=f||r>Math.ceil(s.length/2))throw new Error("maxSize must be an integer number larger than minSize and smaller than half the genelist length");if((a===void 0||a===0)&&(a=9999999999999),Number.isInteger(a)===!1||a<r)throw new Error("maxSizeInput must be an integer number larger-equals than maxSize");const o=new Set(s.map(g=>g.gene)),t=new Set(s.filter(g=>g.signif===!0).map(g=>g.gene)),n=[],i=e.length;let _,c,l,u,m;for(let g=0;g<i;g++)if(_=e[g].genesets.length,_>0){m=[];for(let N=0;N<_;N++){if(c=e[g].genesets[N].genes,!Array.isArray(c))throw console.error(e[g].genesets[N]),new Error("invalid genesets object; no genes available for geneset at index "+N+" at source index "+g);c.length<a&&(l=c.filter(M=>o.has(M)),l.length>=f&&l.length<=r&&(u=l.filter(M=>t.has(M)),m.push({id:e[g].genesets[N].id,name:e[g].genesets[N].name,parents:e[g].genesets[N].parents,ngenes_input:c.length,ngenes:l.length,ngenes_signif:u.length,genes:l,genes_signif:u})))}n.push({source:e[g].source,source_version:e[g].source_version,genesets:m})}return n}function $(e,s){return s.sigma_0+s.sigma_1*e+s.sigma_2*Math.pow(e,2)+s.sigma_3*Math.pow(e,3)+s.sigma_4*Math.pow(e,4)+s.sigma_5*Math.pow(e,5)+s.sigma_6*Math.pow(e,6)+s.sigma_7*Math.pow(e,7)+s.sigma_8*Math.pow(e,8)+s.sigma_9*Math.pow(e,9)}function x(e,s){return s.xi_0+s.xi_1*e+s.xi_2*Math.pow(e,2)+s.xi_3*Math.pow(e,3)+s.xi_4*Math.pow(e,4)+s.xi_5*Math.pow(e,5)+s.xi_6*Math.pow(e,6)+s.xi_7*Math.pow(e,7)+s.xi_8*Math.pow(e,8)+s.xi_9*Math.pow(e,9)+s.xi_10*Math.pow(e,10)+s.xi_11*Math.pow(e,11)}function Q(e,s){const f=Math.log(e),r=$(f,s);let a=Math.exp(x(f,s));return a=a<1?1:a,{sd:r,xi:a}}const Y=2220446049250313e-31,B=5.656854249492381,W=.3989422804014327,y=1,H=2,J=4,U=8,X=16,K=[2.2352520354606837,161.02823106855587,1067.6894854603709,18154.98125334356,.06568233791820745],Z=[47.202581904688245,976.0985517377767,10260.932208618979,45507.78933502673],b=[.39894151208813466,8.883149794388377,93.50665613217785,597.2702763948002,2494.5375852903726,6848.190450536283,11602.65143764735,9842.714838383978,10765576773720192e-24],j=[22.266688044328117,235.387901782625,1519.3775994075547,6485.558298266761,18615.571640885097,34900.95272114598,38912.00328609327,19685.429676859992],ee=[.215898534057957,.12740116116024736,.022235277870649807,.0014216191932278934,29112874951168793e-21,.023073441764940174],ne=[1.284260096144911,.4682382124808651,.06598813786892856,.0037823963320275824,7297515550839662e-20],O=e=>e?-1/0:0,A=e=>e?0:1,P=(e,s)=>e?O(s):A(s),T=(e,s)=>e?A(s):O(s);function E(e,s,f,r,a){var o;if(isNaN(e)||isNaN(s)||isNaN(f))return NaN;if(!Number.isFinite(e)&&s===e)return NaN;if(f<=0)return f<0?NaN:e<s?P(r,a):T(r,a);if(o=(e-s)/f,!Number.isFinite(o))return e<s?P(r,a):T(r,a);e=o;var t=se(e,r?0:1,a);return r?t.cum:t.ccum}function v(e,s){return e===0?s?Number.NEGATIVE_INFINITY:0:s?0:1}function se(e,s,f){var r,a,o,t,n,i,_,c,l,u,m,g,N=K,M=Z,h=b,w=j,p=ee,d=ne;if(isNaN(e))return{cum:NaN,ccum:NaN};if(_=Y*.5,m=s!==1,g=s!==0,l=Math.abs(e),l<=.67448975){if(l>_)for(c=e*e,t=N[4]*c,o=c,u=0;u<3;++u)t=(t+N[u])*c,o=(o+M[u])*c;else t=o=0;n=e*(t+N[3])/(o+M[3]),m&&(r=.5+n),g&&(a=.5-n),f&&(m&&(r=Math.log(r)),g&&(a=Math.log(a)))}else if(l<=B){for(t=h[8]*l,o=l,u=0;u<7;++u)t=(t+h[u])*l,o=(o+w[u])*l;n=(t+h[7])/(o+w[7]),c=Math.trunc(l*16)/16,i=(l-c)*(l+c),f?(r=-c*c*.5+-i*.5+Math.log(n),(m&&e>0||g&&e<=0)&&(a=Math.log1p(-Math.exp(-c*c*.5)*Math.exp(-i*.5)*n))):(r=Math.exp(-c*c*.5)*Math.exp(-i*.5)*n,a=1-r),e>0&&(n=r,m&&(r=a),a=n)}else if(f&&l<1e170||m&&-37.5193<e&&e<8.2924||g&&e<37.5193){for(c=1/(e*e),t=p[5]*c,o=c,u=0;u<4;++u)t=(t+p[u])*c,o=(o+d[u])*c;n=c*(t+p[4])/(o+d[4]),n=(W-n)/l,c=Math.trunc(e*16)/16,i=(e-c)*(e+c),f?(r=-c*c*.5+-i*.5+Math.log(n),(m&&e>0||g&&e<=0)&&(a=Math.log1p(-Math.exp(-c*c*.5)*Math.exp(-i*.5)*n))):(r=Math.exp(-c*c*.5)*Math.exp(-i*.5)*n,a=1-r),e>0&&(n=r,m&&(r=a),a=n)}else e>0?(r=v(1,f),a=v(0,f)):(r=v(0,f),a=v(1,f));return{cum:r,ccum:a}}const te=(e,s)=>s?e:.5-e+.5,ie=(e,s)=>s?.5-e+.5:e;function re(e,s,f,r,a){let o,t,n,i;if(isNaN(e)||isNaN(s)||isNaN(f))return e+s+f;try{fe(e,r,a,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY)}catch(_){return _}return f<0?R():f===0?s:(o=ae(e,r,a),t=o-.5,Math.abs(t)<=.425?(n=.180625-t*t,i=t*(((((((n*2509.0809287301227+33430.57558358813)*n+67265.7709270087)*n+45921.95393154987)*n+13731.69376550946)*n+1971.5909503065513)*n+133.14166789178438)*n+3.3871328727963665)/(((((((n*5226.495278852854+28729.085735721943)*n+39307.89580009271)*n+21213.794301586597)*n+5394.196021424751)*n+687.1870074920579)*n+42.31333070160091)*n+1)):(t>0?n=oe(e,r,a):n=o,n=Math.sqrt(-(a&&(r&&t<=0||!r&&t>0)?e:Math.log(n))),n<=5?(n+=-1.6,i=(((((((n*.0007745450142783414+.022723844989269184)*n+.2417807251774506)*n+1.2704582524523684)*n+3.6478483247632045)*n+5.769497221460691)*n+4.630337846156546)*n+1.4234371107496835)/(((((((n*10507500716444169e-25+.0005475938084995345)*n+.015198666563616457)*n+.14810397642748008)*n+.6897673349851)*n+1.6763848301838038)*n+2.053191626637759)*n+1)):(n+=-5,i=(((((((n*20103343992922881e-23+27115555687434876e-21)*n+.0012426609473880784)*n+.026532189526576124)*n+.29656057182850487)*n+1.7848265399172913)*n+5.463784911164114)*n+6.657904643501103)/(((((((n*20442631033899397e-31+1421511758316446e-22)*n+18463183175100548e-21)*n+.0007868691311456133)*n+.014875361290850615)*n+.1369298809227358)*n+.599832206555888)*n+1)),t<0&&(i=-i)),s+f*i)}function fe(e,s,f,r,a){if(f){if(e>0)throw R();if(e===0)throw s?a:r;if(e===Number.NEGATIVE_INFINITY)throw s?r:a}else{if(e<0||e>1)throw R();if(e===0)throw s?r:a;if(e===1)throw s?a:r}}function ae(e,s,f){return f?s?Math.exp(e):-Math.expm1(e):te(e,s)}function oe(e,s,f){return f?s?-Math.expm1(e):Math.exp(e):ie(e)}function R(){return _e(y,""),NaN}function _e(e,s){if(e>y){let f="";switch(e){case y:f=`argument out of domain in ${s}`;break;case H:f=`value out of range in ${s}`;break;case J:f=`convergence failed in ${s}`;break;case U:f=`full precision may not have been achieved in ${s}`;break;case X:f=`underflow occurred in ${s}`;break}console.error(f)}}})();
